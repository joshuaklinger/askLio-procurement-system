{% extends "base.html" %}

{% block title %}New Procurement Request{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <h2>üìù New Procurement Request</h2>
    <p class="text-muted">Start by uploading your vendor offer to auto-fill the form, or enter details manually.</p>
    <hr>
    
    <div class="card p-4 mb-4 bg-light">
        <h4 class="card-title">Upload Vendor Offer for Auto-Fill</h4>
        <form method="POST" enctype="multipart/form-data" id="upload-form">
            <div class="mb-3">
                <label for="offer_file" class="form-label">Select PDF/Image Offer</label>
                <input class="form-control" type="file" id="offer_file" name="offer_file" accept=".pdf,.png,.jpg" required>
            </div>
            <button type="submit" class="btn btn-info">Extract Data</button>
        </form>
    </div>

    <form method="POST" action="{{ url_for('new_request') }}" id="submission-form">
        <div class="row">
            <div class="col-md-6">
                <h4>Request Details</h4>
                <div class="mb-3">
                    <label class="form-label">Requestor Name <span class="text-danger">*</span></label>
                    <input type="text" name="requestor_name" class="form-control" required value="{{ data.requestor_name if data.requestor_name }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Department <span class="text-danger">*</span></label>
                    <input type="text" name="department" class="form-control" required value="{{ data.department if data.department }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Title/Short Description <span class="text-danger">*</span></label>
                    <input type="text" name="title" class="form-control" required placeholder="e.g., MacBook Air for Engineering">
                </div>
                <div class="mb-3">
                    <label class="form-label">Commodity Group (Auto-Classified)</label>
                    <select name="commodity_group" class="form-select">
                        {% for group in all_groups %}
                            <option value="{{ group }}" {% if data.commodity_group == group %}selected{% endif %}>{{ group }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Auto-classified by system. Please correct if necessary.</div>
                </div>
            </div>

            <div class="col-md-6">
                <h4>Vendor Details (Extracted)</h4>
                <div class="mb-3">
                    <label class="form-label">Vendor Name</label>
                    <input type="text" name="vendor_name" class="form-control" value="{{ data.vendor_name }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">VAT ID (Umsatzsteuer-ID)</label>
                    <input type="text" name="vat_id" class="form-control" value="{{ data.vat_id }}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Total Cost (‚Ç¨) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" name="total_cost" id="total-cost" class="form-control fw-bold" readonly value="{{ '%.2f' % data.total_cost if data.total_cost else '0.00' }}">
                    <div class="form-text">Automatically calculated from Order Lines.</div>
                </div>
            </div>
        </div>
        
        <h4 class="mt-4">Order Lines (Editable)</h4>
        <table class="table table-bordered" id="order-lines-table">
            <thead>
                <tr>
                    <th>Description <span class="text-danger">*</span></th>
                    <th style="width: 15%">Unit Price (‚Ç¨) <span class="text-danger">*</span></th>
                    <th style="width: 10%">Amount <span class="text-danger">*</span></th>
                    <th style="width: 10%">Unit</th>
                    <th style="width: 15%">Total Price (‚Ç¨)</th>
                    <th style="width: 5%">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for line in data.order_lines %}
                    <tr class="order-line-row">
                        <td><input type="text" name="line_description[]" class="form-control" value="{{ line.description }}" required></td>
                        <td><input type="number" step="0.01" name="line_price[]" class="form-control line-input unit-price" value="{{ '%.2f' % line.unit_price }}" required></td>
                        <td><input type="number" step="0.01" name="line_amount[]" class="form-control line-input amount" value="{{ '%.2f' % line.amount }}" required></td>
                        <td><input type="text" name="line_unit[]" class="form-control" value="{{ line.unit }}"></td>
                        <td><input type="number" step="0.01" name="line_total[]" class="form-control line-total" value="{{ '%.2f' % line.total_price }}" readonly></td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-line">X</button></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" class="btn btn-secondary mb-4" id="add-line">Add Line</button>
        
        <button type="submit" class="btn btn-primary btn-lg w-100 mb-5">Validate and Submit Request</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const tableBody = document.querySelector('#order-lines-table tbody');
    const totalCostInput = document.querySelector('#total-cost');
    const addButton = document.querySelector('#add-line');

    function calculateTotal() {
        let grandTotal = 0;
        document.querySelectorAll('.order-line-row').forEach(row => {
            // Use parseFloat or 0 if input is empty/invalid
            const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
            const amount = parseFloat(row.querySelector('.amount').value) || 0;
            const lineTotalInput = row.querySelector('.line-total');
            
            const lineTotal = unitPrice * amount;
            lineTotalInput.value = lineTotal.toFixed(2);
            grandTotal += lineTotal;
        });
        totalCostInput.value = grandTotal.toFixed(2);
    }

    function addLine(data = { description: '', unit_price: 0, amount: 1, unit: 'Stk.', total_price: 0 }) {
        const newRow = document.createElement('tr');
        newRow.classList.add('order-line-row');
        newRow.innerHTML = `
            <td><input type="text" name="line_description[]" class="form-control" value="${data.description}" required></td>
            <td><input type="number" step="0.01" name="line_price[]" class="form-control line-input unit-price" value="${data.unit_price.toFixed(2)}" required></td>
            <td><input type="number" step="0.01" name="line_amount[]" class="form-control line-input amount" value="${data.amount}" required></td>
            <td><input type="text" name="line_unit[]" class="form-control" value="${data.unit}"></td>
            <td><input type="number" step="0.01" name="line_total[]" class="form-control line-total" value="${data.total_price.toFixed(2)}" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-line">X</button></td>
        `;
        tableBody.appendChild(newRow);
        
        // Add listeners to new inputs
        newRow.querySelectorAll('.line-input').forEach(input => {
            input.addEventListener('input', calculateTotal);
        });
        // Add listener to new remove button
        newRow.querySelector('.remove-line').addEventListener('click', function() {
            newRow.remove();
            calculateTotal();
        });
        calculateTotal(); 
    }

    // Attach listeners to initial rows and add button
    document.querySelectorAll('.line-input').forEach(input => {
        input.addEventListener('input', calculateTotal);
    });
    document.querySelectorAll('.remove-line').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.order-line-row').remove();
            calculateTotal();
        });
    });

    addButton.addEventListener('click', () => addLine());
    
    // Initial calculation on load for extracted data
    calculateTotal();
});
</script>
{% endblock %}